
<!DOCTYPE html>   
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CFC NFT Creator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- XUMM SDK -->
<script src="https://xumm.app/assets/cdn/xumm.min.js"></script>

<style>
    body { margin:0; background:#000; font-family:Arial,sans-serif; }
    .outer { padding:40px 0; display:flex; justify-content:center; }
    .container {
        width:90%; max-width:700px;
        background:#fff; padding:30px; border-radius:12px;
    }
    h1 { text-align:center; color:#000; margin-bottom:20px; }
    label { font-weight:bold; margin-top:15px; display:block; }
    input, textarea {
        width:100%; padding:12px; margin-top:6px;
        border:1px solid #ccc; border-radius:6px; font-size:16px;
    }
    button {
        width:100%; padding:15px; margin-top:25px;
        background:#111; color:#fff; border:none;
        border-radius:6px; font-size:18px; cursor:pointer;
    }
    button:hover { background:#333; }
    .disabled { background:#666!important; cursor:not-allowed!important; }
    .info-box {
        background:#f2f2f2; padding:15px; margin-top:25px;
        border-radius:8px; font-size:15px; line-height:1.5;
    }
    .success {
        background:#e6ffe6; border-left:4px solid #2ca02c;
        padding:10px; margin-top:20px;
    }

    .status-panel {
        margin-top:30px;
        border-top:2px solid #ddd;
        padding-top:25px;
    }
    .status-card {
        background:#fafafa;
        padding:15px;
        border-radius:8px;
        margin-bottom:15px;
        border-left:5px solid #777;
    }
    .status-title { font-weight:bold; margin-bottom:8px; }
    .pending { border-color:#FFC107; }
    .approved { border-color:#17A2B8; }
    .paid { border-color:#007BFF; }
    .minted { border-color:#28A745; }

    .char-counter {
        font-size:12px;
        color:#666;
        text-align:right;
        margin-top:4px;
    }

    .collapsed-text {
        display:-webkit-box;
        -webkit-line-clamp:3;
        -webkit-box-orient:vertical;
        overflow:hidden;
    }
    .read-more {
        color:#007BFF;
        font-size:13px;
        cursor:pointer;
        margin-top:4px;
        display:inline-block;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] { -moz-appearance: textfield; }
</style>
</head>

<body>

<div class="outer">
<div class="container">

<h1>Create Your NFT</h1>

<button id="connectBtn" onclick="connectWallet()">Connect Xaman Wallet</button>
<div id="walletBox" style="margin-top:15px;font-size:16px;"></div>

<label>Upload File (Image, Video, PDF)</label>
<input type="file" id="fileInput">

<label>NFT Name</label>
<input type="text" id="nftName" maxlength="100">
<div id="countName" class="char-counter">0 / 100</div>

<label>Description</label>
<textarea id="nftDescription" rows="4" maxlength="750"></textarea>
<div id="countDescription" class="char-counter">0 / 750</div>

<label>Terms</label>
<textarea id="nftTerms" rows="4" maxlength="750"></textarea>
<div id="countTerms" class="char-counter">0 / 750</div>

<label>Email (required)</label>
<input type="email" id="email" name="email" placeholder="you@yourdomain.com" required>
<label>Website (optional)</label>
<input
  type="url"
  id="website"
  name="website"
  placeholder="https://yourwebsite.com"
/>

<label>Quantity (1–100)</label>
<input type="number" id="quantity" min="1" max="100" oninput="if (this.value > 100) this.value = 100;">

<label>Price (XRP)</label>
<input type="number" id="priceXRP">

<label>Price (RLUSD)</label>
<input type="number" id="priceRLUSD">

<label>Royalty</label>
<input type="text" value="5% (standard)" disabled>

<button id="submitBtn" onclick="submitNFT()">Submit NFT for Approval</button>

<div id="result"></div>

<div class="info-box">
<strong>NFT Creation Process</strong><br><br>
1️⃣ Connect your Xaman wallet<br>
2️⃣ Upload file + fill out details<br>
3️⃣ Submit NFT for approval (up to 24 hours)<br>
4️⃣ After approval, pay the 5 XRP minting fee<br>
5️⃣ Xaman will then open the Mint signing request<br>
6️⃣ You will be redirected back here after each sign<br>
</div>

<div id="statusPanel" class="status-panel"></div>

<h2 style="margin-top:40px;">My Minted NFTs</h2>
<div id="mintedGallery"></div>

</div>
</div>

<script>
const BACKEND = "https://cfc-nft-creator-backend.onrender.com/";

function updateCounter(idInput, idCounter, max) {
    const el = document.getElementById(idInput);
    const counter = document.getElementById(idCounter);
    el.addEventListener("input", () => {
        counter.textContent = el.value.length + " / " + max;
    });
}

updateCounter("nftName", "countName", 100);
updateCounter("nftDescription", "countDescription", 750);
updateCounter("nftTerms", "countTerms", 750);

const xumm = new Xumm("eebd4c17-c3ef-435b-b891-89afb99e259e");

let userWallet = "";

const PAY_UUID_KEY = "cfc_last_pay_uuid";
const PAY_SUB_KEY  = "cfc_last_pay_submission";
const MINT_UUID_KEY = "cfc_last_mint_uuid";

async function fetchMetadata(cid) {
    try {
        const r = await fetch("https://gateway.pinata.cloud/ipfs/" + cid);
        return await r.json();
    } catch (e) { return null; }
}

async function checkXummPaymentFromStorage() {
    const uuid = localStorage.getItem(PAY_UUID_KEY);
    const submissionId = localStorage.getItem(PAY_SUB_KEY);
    if (!uuid || !submissionId) return;
    try {
        const payload = await xumm.payload.get(uuid);
        if (payload && (payload.signed || payload.meta?.signed)) {
            const res = await fetch(BACKEND + "api/mark-paid", {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({ id:Number(submissionId), uuid })
            });
            const data = await res.json();
            localStorage.removeItem(PAY_UUID_KEY);
            if (data.mintCreated && data.mintLink) {
                localStorage.setItem(MINT_UUID_KEY, data.mintUuid);
                window.open(data.mintLink, "_blank");
            }
            await loadStatus();
        }
    } catch(e){}
}

async function checkXummMintFromStorage() {
    const mintUuid = localStorage.getItem(MINT_UUID_KEY);
    const submissionId = localStorage.getItem(PAY_SUB_KEY);
    if (!mintUuid || !submissionId) return;
    try {
        const payload = await xumm.payload.get(mintUuid);
        if (payload && (payload.signed || payload.meta?.signed)) {
            await fetch(BACKEND + "api/mark-minted", {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({ id:Number(submissionId), uuid:mintUuid })
            });
            localStorage.removeItem(MINT_UUID_KEY);
            await loadStatus();
        }
    } catch(e){}
}

async function connectWallet() {
    const popup = await xumm.authorize();
    if (popup.me?.account) {
        userWallet = popup.me.account;
        document.getElementById("walletBox").innerHTML =
            "Wallet: <strong>" + userWallet + "</strong>";
        document.getElementById("connectBtn").innerHTML = "Disconnect Wallet";
        document.getElementById("connectBtn").onclick = disconnectWallet;
        await loadStatus();
        await checkXummPaymentFromStorage();
        await checkXummMintFromStorage();
    }
}

function disconnectWallet() {
    xumm.logout();
    userWallet = "";
    document.getElementById("walletBox").innerHTML = "";
    document.getElementById("connectBtn").innerHTML = "Connect Xaman Wallet";
    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("statusPanel").innerHTML = "";
}

async function loadStatus() {
    if (!userWallet) return;
    const r = await fetch(BACKEND + "api/admin/submissions?password=CFCBaby3!");
    const items = await r.json();
    const mine = items.filter(x => x.creator_wallet === userWallet);
    let html = "<h2>My Submissions</h2>";
    if (!mine.length) {
        html += "<p>You have no submissions yet.</p>";
        document.getElementById("statusPanel").innerHTML = html;
        return;
    }
    mine.forEach(sub => {
        let cls = "pending";
        if (sub.status === "approved" && sub.payment_status === "unpaid") cls = "approved";
        if (sub.payment_status === "paid" && sub.mint_status === "pending") cls = "paid";
        if (sub.mint_status === "minted") cls = "minted";
        if (sub.status === "rejected") cls = "rejected";
        html += `
        <div class="status-card ${cls}">
            <div class="status-title">${sub.name}</div>
            <div>
  Status:
  <strong>
    ${
      sub.status === "rejected"
        ? "❌ REJECTED — check your email"
        : cls.toUpperCase()
    }
  </strong>
</div>
            <div>Qty: ${sub.batch_qty}</div>

            <div>Metadata: 
                <a href="https://gateway.pinata.cloud/ipfs/${sub.metadata_cid}" target="_blank">View</a>
            </div>
        `;
        if (sub.status === "approved" && sub.payment_status === "unpaid") {
            html += `<button onclick="payNow(${sub.id})">Pay 5 XRP Mint Fee</button>`;
        }
        if (sub.payment_status === "paid" && sub.mint_status !== "minted") {
            html += `<button onclick="mintNow(${sub.id})">Mint NFT</button>`;
        }
        if (sub.mint_status === "minted") {
            html += `<div style="margin-top:10px;color:#28A745;font-weight:bold;">Minted ✔</div>`;
        }
        html += `</div>`;
    });
    document.getElementById("statusPanel").innerHTML = html;
    await loadMintedGallery();
}

async function submitNFT() {
    if (!userWallet) return alert("Please connect your wallet.");
    const file = document.getElementById("fileInput").files[0];
    const name = document.getElementById("nftName").value;
    const description = document.getElementById("nftDescription").value;
    if (!file || !name || !description)
        return alert("Fill all required fields.");

    const fd = new FormData();
    fd.append("file", file);
    const upload = await (await fetch(BACKEND + "api/upload", { method:"POST", body:fd })).json();

    // --------------------------
    // CLEAN NUMERIC VALIDATION
    // --------------------------
    function cleanNum(v) {
        const n = Number(v);
        return n > 0 ? n : null;
    }

    const metadata = {
        name,
        description,
        terms: document.getElementById("nftTerms").value,
        quantity: document.getElementById("quantity").value,
        price_xrp: cleanNum(document.getElementById("priceXRP").value),
        price_rlusd: cleanNum(document.getElementById("priceRLUSD").value),
        image: "ipfs://" + upload.cid,
    };

    const fd2 = new FormData();
    fd2.append("file",
        new Blob([JSON.stringify(metadata)], {type:"application/json"}),
        "metadata.json"
    );
    const md = await (await fetch(BACKEND + "api/upload", { method:"POST", body:fd2 })).json();

    await fetch(BACKEND + "api/submit", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            wallet:userWallet,
            name,
            description,
            imageCid: upload.cid,
            metadataCid: md.cid,
            quantity: document.getElementById("quantity").value,
            metadata: JSON.stringify({
                terms: metadata.terms,
                price_xrp: metadata.price_xrp,
                price_rlusd: metadata.price_rlusd
            })
        })
    });

    document.getElementById("result").innerHTML =
        `<div class="success">NFT Submitted!</div>`;

    document.getElementById("fileInput").value = "";
    document.getElementById("nftName").value = "";
    document.getElementById("nftDescription").value = "";
    document.getElementById("nftTerms").value = "";
    document.getElementById("quantity").value = "";
    document.getElementById("priceXRP").value = "";
    document.getElementById("priceRLUSD").value = "";
    document.getElementById("email").value = "";
    document.getElementById("website").value = "";

    loadStatus();
}

async function payNow(submissionId) {
    const r = await fetch(BACKEND + "api/pay-xrp", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ submissionId })
    });
    const d = await r.json();
    localStorage.setItem(PAY_UUID_KEY, d.uuid);
    localStorage.setItem(PAY_SUB_KEY, String(submissionId));
    window.open(d.link, "_blank");
}

async function mintNow(id) {
    const r = await fetch(BACKEND + "api/start-mint", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ id })
    });
    const d = await r.json();
    localStorage.setItem(MINT_UUID_KEY, d.uuid);
    window.open(d.link, "_blank");
}

async function loadMintedGallery() {
    if (!userWallet) return;
    const r = await fetch(BACKEND + "api/admin/submissions?password=CFCBaby3!");
    const items = await r.json();
    const minted = items.filter(x =>
        x.creator_wallet === userWallet && x.mint_status === "minted"
    );
    let html = "";
    for (const nft of minted) {
        const md = await fetchMetadata(nft.metadata_cid);
        const desc = md?.description || nft.description;
        const terms = md?.terms || "—";
        html += `
            <div style="
                background:#fafafa;
                padding:15px;
                margin-bottom:15px;
                border-radius:10px;
                border-left:5px solid #28A745;
            ">
                <img src="https://gateway.pinata.cloud/ipfs/${nft.image_cid}"
                     style="width:120px;border-radius:6px;margin-bottom:10px;">

                <div><strong>${md?.name || nft.name}</strong></div>

                <div class="collapsed-text" id="desc-${nft.id}">
                    ${desc}
                </div>
                <span class="read-more" onclick="toggleText('desc-${nft.id}')">Read more</span>

                <div class="collapsed-text" id="terms-${nft.id}" style="margin-top:6px;">
                    <strong>Terms:</strong> ${terms}
                </div>
                <span class="read-more" onclick="toggleText('terms-${nft.id}')">Read more</span>

                <div style="font-size:14px;margin-top:4px;">
                    <strong>Price:</strong> ${md?.price_xrp || "—"} XRP 
                    | ${md?.price_rlusd || "—"} RLUSD
                </div>

                <a href="https://gateway.pinata.cloud/ipfs/${nft.metadata_cid}" 
                   target="_blank"
                   style="display:inline-block;margin-top:8px;font-size:14px;">
                   View Metadata →
                </a>
            </div>
        `;
    }
    document.getElementById("mintedGallery").innerHTML = html;
}

function toggleText(id) {
    const el = document.getElementById(id);
    const link = el.nextElementSibling;
    if (el.classList.contains("collapsed-text")) {
        el.classList.remove("collapsed-text");
        link.textContent = "See less";
    } else {
        el.classList.add("collapsed-text");
        link.textContent = "Read more";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    checkXummPaymentFromStorage();
    checkXummMintFromStorage();
});

// -------------------------------------------------------
// AUTO-POPULATE XRP ↔ RLUSD USING LIVE PRICE
// -------------------------------------------------------
let xrpPriceUSD = 0;

async function fetchXRPPrice() {
    try {
        const r = await fetch(
            "https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd"
        );
        const d = await r.json();
        xrpPriceUSD = d.ripple.usd;
    } catch (e) {
        console.warn("Failed to fetch XRP price");
    }
}
fetchXRPPrice();
setInterval(fetchXRPPrice, 20000);

const xrpInput = document.getElementById("priceXRP");
const rlusdInput = document.getElementById("priceRLUSD");

xrpInput.addEventListener("input", () => {
    if (!xrpPriceUSD) return;
    if (xrpInput.value === "") {
        rlusdInput.value = "";
        return;
    }
    const usd = Number(xrpInput.value) * xrpPriceUSD;
    rlusdInput.value = usd.toFixed(2);
});

rlusdInput.addEventListener("input", () => {
    if (!xrpPriceUSD) return;
    if (rlusdInput.value === "") {
        xrpInput.value = "";
        return;
    }
    const xrp = Number(rlusdInput.value) / xrpPriceUSD;
    xrpInput.value = xrp.toFixed(4);
});

</script>  
<script>
function sendHeight() {
    const height = document.body.scrollHeight;
    window.parent.postMessage({ cfcHeight: height }, "*");
}

setInterval(sendHeight, 500);
window.onload = sendHeight;
</script>

</body>
</html>
